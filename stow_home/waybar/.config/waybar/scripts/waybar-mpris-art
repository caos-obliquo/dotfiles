#!/bin/bash
if ! command -v playerctl &> /dev/null; then
    echo '{"text":"NO PLAYER","class":"stopped","tooltip":"playerctl not installed"}'
    exit 0
fi

STATUS=$(playerctl status 2>/dev/null)
if [[ $? -ne 0 || -z "$STATUS" ]]; then
    echo '{"text":"nothing playing","class":"stopped","tooltip":"No active player"}'
    exit 0
fi

ARTIST=$(playerctl metadata artist 2>/dev/null | tr -d '\n' | head -c 200)
TITLE=$(playerctl metadata title 2>/dev/null | tr -d '\n' | head -c 200)
ALBUM=$(playerctl metadata album 2>/dev/null | tr -d '\n' | head -c 200)
YEAR=$(playerctl metadata xesam:contentCreated 2>/dev/null | cut -d'-' -f1)

[[ -z "$ARTIST" ]] && ARTIST="Unknown"
[[ -z "$TITLE" ]] && TITLE="Unknown"

case "$STATUS" in
    Playing) ICON="⏸"; CLASS="playing" ;;
    Paused) ICON="▶"; CLASS="paused" ;;
    *) echo '{"text":"stopped","class":"stopped"}' && exit 0 ;;
esac

# Scrolling display
FULL="${ARTIST} - ${TITLE}"
MAX=50
if [ ${#FULL} -gt $MAX ]; then
    SPACING="   "
    LOOP="${FULL}${SPACING}${FULL}"
    LEN=$((${#FULL} + 3))
    POS=$(( ($(date +%s) * 2) % LEN ))
    DISPLAY="${LOOP:$POS:$MAX}"
else
    DISPLAY="$FULL"
fi

TIP="<span alpha='85%'>Artist:</span>  <b>${ARTIST}</b>"
TIP="${TIP}\\n<span alpha='85%'>Song:</span>    ${TITLE}"
[[ -n "$ALBUM" ]] && TIP="${TIP}\\n<span alpha='85%'>Album:</span>   ${ALBUM}"
[[ -n "$YEAR" ]] && TIP="${TIP}\\n<span alpha='70%'>Year:</span>    ${YEAR}" || TIP="${TIP}\\n<span alpha='70%'>Year:</span>    Unknown"

echo "{\"text\":\"${ICON} ${DISPLAY}\",\"class\":\"${CLASS}\",\"tooltip\":\"${TIP}\"}"
